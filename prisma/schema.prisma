generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/**
 * ====================
 * MODELS
 * ====================
 */

model User {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String  @unique
  firstName String
  lastName  String
  phone     String?
  age       Int?

  currentCompanyId String?  @db.Uuid
  currentCompany   Company? @relation("CurrentCompany", fields: [currentCompanyId], references: [id])

  createdAt DateTime @default(dbgenerated("now()"))
  updatedAt DateTime @default(dbgenerated("now()")) @updatedAt
  profilePictureUrl String? 


  // rela»õii
  memberships Membership[]
  roles       Role[]       @relation("RoleUsers")
  contracts   Contract[]   @relation("ContractOwner")
  signatures  Signature[]
  invoices    Invoice[]
  comments    Comment[]
  activities  Activity[]
  templates   Template[]   @relation("TemplateCreator")

  onboarding             Onboarding?
  userTemplateCategories UserTemplateCategory[]

  @@index([currentCompanyId])
  // table mapping
  @@map("users")
}

model Company {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  cui         String  @unique
  regNumber   String?
  emailDomain String?

  logoUrl        String?
  colorPrimary   String?
  colorSecondary String?
  colorAccent    String?

  createdAt DateTime @default(dbgenerated("now()"))
  updatedAt DateTime @default(dbgenerated("now()")) @updatedAt

  // üîÅ back-relation pentru User.currentCompany
  currentUsers User[] @relation("CurrentCompany")

  // restul rela»õiilor reale (nu mai avem users generic)
  memberships Membership[]
  contracts   Contract[]
  templates   Template[]
  invoices    Invoice[]
  roles       Role[]

  @@index([name])
  // table mapping
  @@map("companies")
}

model Membership {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  companyId String   @db.Uuid
  roleKey   RoleKey  @default(MEMBER) // high-level role (not the Role entity)
  createdAt DateTime @default(dbgenerated("now()"))

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([companyId])
  @@index([userId])
  // table mapping
  @@map("memberships")
}

model Role {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  permissions Json? // @db.Json
  companyId   String  @db.Uuid

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // optional many-to-many users<->roles inside a company
  users User[] @relation("RoleUsers")

  @@unique([companyId, name])
  @@index([companyId])
  // table mapping
  @@map("roles")
}

model Contract {
  id     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title  String
  status ContractStatus @default(DRAFT)

  ownerId String @db.Uuid
  owner   User   @relation("ContractOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  companyId String?  @db.Uuid
  company   Company? @relation(fields: [companyId], references: [id])

  // optional: original/signed file urls
  draftPdfUrl  String?
  signedPdfUrl String?

  createdAt DateTime  @default(dbgenerated("now()"))
  updatedAt DateTime  @default(dbgenerated("now()")) @updatedAt
  lastSentAt DateTime?
  expiresAt String?
  signingDeadline String?

  accessPassword Int

  ownerSignatureId    String @db.Uuid
  receiverSignatureId String @db.Uuid

  receiverName     String
  receiverEmail    String
  receiverToken    String @db.Uuid
  optionalMessage  String
  currentVersionId String

  failedReason String?
  failedAt     DateTime

  comments         Comment[]
  activities       Activity[]
  parties          Party[]
  placements       SignaturePlacement[]
  invites          Invite[]
  signature        Signature            @relation(fields: [ownerSignatureId], references: [id])
  contractVersions ContractVersion[]
  auditLogs        AuditLog[]

  @@index([companyId, status, createdAt])
  @@index([ownerId])
  // table mapping
  @@map("contracts")
}

model ContractVersion {
  id         String   @id @default(uuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  versionNumber Int
  content       String    @db.Text
  createdAt     DateTime  @default(now())
  createdBy     String? // ownerId / signerEmail / system
  createdByType PartyRole

  metadata Json?

  @@index([contractId, versionNumber])
}

model Party {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId   String    @db.Uuid
  email        String
  name         String?
  role         PartyRole @default(SIGNER)
  signingOrder Int       @default(1)
  hasSigned    Boolean   @default(false)
  signedAt     DateTime?

  contract   Contract             @relation(fields: [contractId], references: [id], onDelete: Cascade)
  // signatures Signature[]
  placements SignaturePlacement[]
  invites    Invite[]

  @@unique([contractId, email])
  @@index([contractId, signingOrder])
  // table mapping
  @@map("parties")
}

model Invite {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId String    @db.Uuid
  partyId    String    @db.Uuid
  token      String    @unique
  expiresAt  DateTime?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  party    Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([partyId])
  // table mapping
  @@map("invites")
}

model SignaturePlacement {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  contractId String   @db.Uuid
  partyId    String   @db.Uuid
  page       Int
  x          Float
  y          Float
  width      Float
  height     Float
  createdAt  DateTime @default(dbgenerated("now()"))

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  party    Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([partyId])
  // table mapping
  @@map("signature_placements")
}

model Signature {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      SignatureType // draw, typed, upload
  title     String?
  imageUrl  String?
  createdAt DateTime      @default(dbgenerated("now()"))

  userId String? @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  contracts Contract[]

  @@index([userId])
  @@map("signatures")
}

model Template {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title     String
  category  String?
  tags      String[]
  content   Json // was String; store JSON template with variables
  updatedAt DateTime @default(dbgenerated("now()")) @updatedAt
  createdAt DateTime @default(dbgenerated("now()"))

  companyId String?  @db.Uuid
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  creatorId String @db.Uuid
  creator   User   @relation("TemplateCreator", fields: [creatorId], references: [id], onDelete: Cascade)

  @@unique([companyId, title])
  @@index([companyId])
  @@index([creatorId])
  // table mapping
  @@map("templates")
}

model Invoice {
  id     String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  number String        @unique
  date   DateTime
  amount Float
  status InvoiceStatus
  pdfUrl String?

  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyId String?  @db.Uuid
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([companyId, date])
  // table mapping
  @@map("invoices")
}

model Comment {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String    @db.Uuid
  contractId String    @db.Uuid
  partyRole  PartyRole
  firstName  String
  lastName   String
  content    String
  createdAt  DateTime  @default(dbgenerated("now()"))

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId, createdAt])
  // table mapping
  @@map("comments")
}

model Activity {
  id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action    ActivityAction
  createdAt DateTime       @default(dbgenerated("now()"))

  userId String? @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  contractId String?   @db.Uuid
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: Cascade)

  meta Json?

  @@index([contractId, createdAt])
  // table mapping
  @@map("activities")
}

model Onboarding {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @unique @db.Uuid
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt          DateTime @default(dbgenerated("now()"))
  data               Json?
  stepsDone          String[] @default([])
  nextUncompleteStep String?

  status OnboardingStatusSimple @default(IN_PROGRESS)

  @@map("onboarding")
}

model UserTemplateCategory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @db.Uuid
  createdAt DateTime @default(dbgenerated("now()"))
  category  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_templates_categories")
}

model AuditLog {
  id         String   @id @default(uuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])

  userId          String? // prestator
  userEmail       String? // client extern
  actorType       PartyRole
  action          AuditAction
  contractVersion Int?
  ip              String?
  userAgent       String?
  metadata        Json?

  createdAt DateTime @default(now())

  @@index([contractId, createdAt])
}

/**
 * ====================
 * ENUMS
 * ====================
 */

enum RoleKey {
  OWNER
  ADMIN
  MEMBER
}

enum ContractStatus {
  DRAFT
  OUT_FOR_SIGNATURE
  FULLY_SIGNED
  DECLINED
  REVOKED
  EXPIRED
}

enum PartyRole {
  SIGNER
  SENDER
  SYSTEM
  ASSISTANT
}

enum SignatureType {
  DRAW
  TYPED
  UPLOAD
}

enum InvoiceStatus {
  PAID
  UNPAID
  OVERDUE
}

enum ActivityAction {
  CREATED
  INVITED
  VIEWED
  SIGNED
  DECLINED
  COMMENTED
  EXPORTED
}

enum OnboardingStatusSimple {
  IN_PROGRESS
  COMPLETED
}

enum AuditAction {
  CONTRACT_CREATED
  CONTRACT_SENT
  CONTRACT_VIEWED
  COMMENT_ADDED
  COMMENT_RESOLVED // Not used
  CONTRACT_UPDATED // TODO
  CONTRACT_SIGNED_OWNER
  CONTRACT_SIGNED_SIGNER
  CONTRACT_DECLINED
  CONTRACT_REVOKED
  CONTRACT_EXPIRED // TODO
  PDF_GENERATED
  CONTRACT_SIGNED_NOTIFICATION_SENT
}
